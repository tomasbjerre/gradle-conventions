import org.gradle.api.model.ObjectFactory
import org.gradle.api.provider.Property
import org.gradle.api.provider.ListProperty

class SignExtension {
	final Property<String> ignoreCommitsIfMessageMatches
	/**
	 * If not prepending, it will rewrite the entire changelog
	 */
	final Property<String> signingKeyEnvOrProp
	final Property<String> signingPasswordEnvOrProp

	SignExtension(ObjectFactory objects) {
		signingKeyEnvOrProp = objects.property(String)
		signingPasswordEnvOrProp = objects.property(String)

		// Set defaults
		signingKeyEnvOrProp.convention("signingkey")
		signingPasswordEnvOrProp.convention("signing.password")
	}
}

project.extensions.create('signExtension', SignExtension, project.objects)
project.plugins.apply 'signing'

signing {

	required {
		gradle.taskGraph.hasTask("closeAndReleaseStagingRepositories")
	}

	project.afterEvaluate {
		def getEnvOrProp = { name ->
			def value = project.providers.environmentVariable(name)
			if (value.present) {
				logger.lifecycle("Using ${name} from environment variable")
				return value
			}
			value = project.provider { project.findProperty(name) as String }
			if (value.present) {
				logger.lifecycle("Using ${name} from property")
				return value
			} else {
				logger.lifecycle("No ${name} found")
			}
			return value
		}

		def signingKeyProvider = getEnvOrProp(project.extensions.signExtension.signingKeyEnvOrProp.get())
		def signingPasswordProvider = getEnvOrProp(project.extensions.signExtension.signingPasswordEnvOrProp.get())
		signing {
			if (signingKeyProvider.present && signingPasswordProvider.present) {
				logger.lifecycle("Configuring signing key and password")
				useInMemoryPgpKeys(signingKeyProvider.get(), signingPasswordProvider.get())
			} else {
				logger.lifecycle("Not configuring signing key and password")
			}
		}
	}
	sign(publishing.publications)
}


tasks.withType(AbstractPublishToMaven) { publishTask ->
	tasks.withType(Sign) { signTask ->
		logger.info("${publishTask} must run after ${signTask}")
		publishTask.mustRunAfter(signTask)
		tasks.withType(Jar) { jarTask ->
			logger.info("${signTask} must run after ${jarTask}")
			signTask.mustRunAfter(jarTask)
		}
	}
}
